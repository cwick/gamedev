<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkanoid</title>
</head>

<body>
    <canvas id="gameCanvas" width="800" height="600" style="display:block;margin:0 auto;background:#000;"></canvas>
    <div id="lockHint" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);color:#fff;font-family:monospace;font-size:14px;text-align:center;">
        Click canvas to lock mouse
    </div>
    <script type="module">
        import init, {
            engine_init,
            engine_step,
            game_state_ptr,
            game_state_len,
        } from '../dist/gamedev_wasm_hello.js';
        import { createInputHandler } from '../input.js';

        const SNAP = Object.freeze({
            PADDLE_X: 0,
            PADDLE_Y: 1,
            PADDLE_WIDTH: 2,
            PADDLE_HEIGHT: 3,
            BALL_X: 4,
            BALL_Y: 5,
            BALL_SIZE: 6,
        });

        let lastTime = 0;
        let mouseDeltaX = 0;

        const keys = createInputHandler({
            left: ['ArrowLeft', 'a', 'A'],
            right: ['ArrowRight', 'd', 'D']
        });

        async function run() {
            const wasmModule = await init();
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const lockHint = document.getElementById('lockHint');

            canvas.addEventListener('click', async () => {
                if (!document.pointerLockElement) {
                    await canvas.requestPointerLock();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === canvas) {
                    mouseDeltaX += e.movementX;
                }
            });

            document.addEventListener('pointerlockchange', () => {
                if (document.pointerLockElement === canvas) {
                    canvas.style.cursor = 'none';
                    lockHint.style.display = 'none';
                } else {
                    canvas.style.cursor = 'default';
                    lockHint.style.display = 'block';
                    mouseDeltaX = 0;
                }
            });

            engine_init('Arkanoid', 800, 600);

            function gameLoop(currentTimeMs) {
                const currentTimeSec = currentTimeMs / 1000.0;
                const deltaTime = lastTime === 0 ? 0 : currentTimeSec - lastTime;
                lastTime = currentTimeSec;

                if (deltaTime > 0.0) {
                    const clampedDelta = Math.max(-256, Math.min(256, Math.round(mouseDeltaX)));
                    const deltaEncoded = (clampedDelta & 0xFFFF) << 16;

                    const input_bits =
                        (keys.left ? 0b0100 : 0) |
                        (keys.right ? 0b1000 : 0) |
                        deltaEncoded;

                    engine_step(deltaTime, input_bits);
                    mouseDeltaX = 0;
                }

                const statePtr = game_state_ptr();
                const stateLen = game_state_len();
                if (statePtr !== 0 && stateLen >= SNAP.BALL_SIZE + 1) {
                    const snapshot = new Float32Array(
                        wasmModule.memory.buffer,
                        statePtr,
                        stateLen,
                    );
                    const paddleX = snapshot[SNAP.PADDLE_X];
                    const paddleY = snapshot[SNAP.PADDLE_Y];
                    const paddleWidth = snapshot[SNAP.PADDLE_WIDTH];
                    const paddleHeight = snapshot[SNAP.PADDLE_HEIGHT];
                    const ballX = snapshot[SNAP.BALL_X];
                    const ballY = snapshot[SNAP.BALL_Y];
                    const ballSize = snapshot[SNAP.BALL_SIZE];

                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = '#00ffcc';
                    ctx.fillRect(paddleX - paddleWidth / 2, paddleY - paddleHeight / 2, paddleWidth, paddleHeight);

                    ctx.fillStyle = '#ffff00';
                    ctx.fillRect(ballX - ballSize / 2, ballY - ballSize / 2, ballSize, ballSize);
                }

                requestAnimationFrame(gameLoop);
            }

            requestAnimationFrame(gameLoop);
        }

        run();
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust WebAssembly Hello World</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0052a3;
        }

        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #0066cc;
            min-height: 50px;
        }

        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .debug-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 320px;
            background: #1a1a2e;
            border-left: 2px solid #0066cc;
            color: #e8e8e8;
            font-family: Consolas, Menlo, monospace;
            font-size: 15px;
            overflow-y: auto;
            z-index: 1000;
            padding: 15px;
            box-sizing: border-box;
        }

        .debug-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }

        .debug-section:last-child {
            border-bottom: none;
        }

        .debug-section h3 {
            color: #66d9ff;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 0 0 8px 0;
            letter-spacing: 1px;
        }

        .debug-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            align-items: center;
        }

        .debug-label {
            color: #aaa;
            text-align: left;
            flex: 1;
        }

        .debug-value {
            color: #00ff00;
            text-align: right;
            font-weight: bold;
            flex: 0 0 auto;
            margin-left: 10px;
        }

        .debug-bool {
            color: #ffaa00;
        }

        .debug-bool.true {
            color: #00ff00;
        }

        .debug-bool.false {
            color: #ff6666;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script type="importmap">
        {
            "imports": {
                "preact": "./vendor/preact.module.js"
            }
        }
    </script>

    <script type="module">
        import { html, render } from "preact";
        import App from './app.js';

        render(html`<${App} />`, document.getElementById("app"));
    </script>

    <script type="module">
        import init, { engine_init, engine_step, game_state_ptr, game_state_len } from './dist/gamedev_wasm_hello.js';
        import { setDebugState } from './app.js';

        const PHASE_GAME_OVER = 1.0;
        const WINNER_PLAYER_ONE = 1.0;
        const SNAP = Object.freeze({
            BALL_X: 0,
            BALL_Y: 1,
            BALL_VX: 2,
            BALL_VY: 3,
            PADDLE1_X: 4,
            PADDLE1_Y: 5,
            PADDLE2_X: 6,
            PADDLE2_Y: 7,
            P1_SCORE: 8,
            P2_SCORE: 9,
            FIELD_W: 10,
            FIELD_H: 11,
            GAME_PHASE: 12,
            WINNER: 13,
            BALL_VISIBLE: 14,
            PADDLE_W: 15,
            PADDLE_H: 16,
        });

        let lastTime = 0;
        let lastDisplayUpdate = 0;
        let wasmModule;

        const keys = {
            p1_up: false,
            p1_down: false,
            action: false
        };

        window.addEventListener('keydown', (e) => {
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') {
                keys.p1_up = true;
                e.preventDefault();
            }
            if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') {
                keys.p1_down = true;
                e.preventDefault();
            }
            if (e.key === ' ') {
                keys.action = true;
                e.preventDefault();
            }
        });

        window.addEventListener('keyup', (e) => {
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') {
                keys.p1_up = false;
            }
            if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') {
                keys.p1_down = false;
            }
            if (e.key === ' ') {
                keys.action = false;
            }
        });

        async function run() {
            try {
                wasmModule = await init();

                document.getElementById('status').textContent = '✅ WebAssembly loaded successfully!';
                document.getElementById('status').style.color = 'green';

                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');

                engine_init(800, 600);

                function gameLoop(currentTime) {
                    const currentTimeSec = currentTime / 1000.0;
                    const deltaTime = lastTime === 0 ? 0 : currentTimeSec - lastTime;
                    lastTime = currentTimeSec;

                    if (deltaTime > 0) {
                        const input_bits = (keys.p1_up ? 0b001 : 0) | (keys.p1_down ? 0b010 : 0) | (keys.action ? 0b100 : 0);
                        engine_step(deltaTime, input_bits);
                    }

                    const statePtr = game_state_ptr();
                    const stateLen = game_state_len();
                    const state = new Float32Array(wasmModule.memory.buffer, statePtr, stateLen);
                    const ball_x = state[SNAP.BALL_X];
                    const ball_y = state[SNAP.BALL_Y];
                    const ball_vx = state[SNAP.BALL_VX];
                    const ball_vy = state[SNAP.BALL_VY];
                    const paddle1_x = state[SNAP.PADDLE1_X];
                    const paddle1_y = state[SNAP.PADDLE1_Y];
                    const paddle2_x = state[SNAP.PADDLE2_X];
                    const paddle2_y = state[SNAP.PADDLE2_Y];
                    const p1_score = state[SNAP.P1_SCORE];
                    const p2_score = state[SNAP.P2_SCORE];
                    const game_phase = state[SNAP.GAME_PHASE];
                    const winner = state[SNAP.WINNER];
                    const ball_visible = state[SNAP.BALL_VISIBLE];
                    const paddle_width = state[SNAP.PADDLE_W];
                    const paddle_height = state[SNAP.PADDLE_H];

                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([15, 15]);
                    ctx.beginPath();
                    ctx.moveTo(canvas.width / 2, 0);
                    ctx.lineTo(canvas.width / 2, canvas.height);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(paddle1_x - paddle_width / 2, paddle1_y - paddle_height / 2, paddle_width, paddle_height);
                    ctx.fillRect(paddle2_x - paddle_width / 2, paddle2_y - paddle_height / 2, paddle_width, paddle_height);

                    ctx.fillStyle = '#FFFFFF';
                    const ballSize = 12;
                    if (ball_visible) {
                        ctx.fillRect(ball_x - ballSize / 2, ball_y - ballSize / 2, ballSize, ballSize);
                    }

                    ctx.font = '48px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(String(p1_score), canvas.width / 4, 60);
                    ctx.fillText(String(p2_score), (canvas.width * 3) / 4, 60);

                    if (game_phase === PHASE_GAME_OVER) {
                        const winnerName = winner === WINNER_PLAYER_ONE ? 'PLAYER 1' : 'PLAYER 2';
                        ctx.font = '36px monospace';
                        ctx.fillText(winnerName + ' WINS', canvas.width / 2, canvas.height / 2);
                        ctx.font = '20px monospace';
                        ctx.fillText('PRESS SPACE TO RESTART', canvas.width / 2, canvas.height / 2 + 40);
                    }

                    if (currentTimeSec - lastDisplayUpdate >= 0.1) {
                        setDebugState({
                            ball_x,
                            ball_y,
                            paddle1_y,
                            paddle2_y,
                            p1_score,
                            p2_score,
                            game_phase,
                            stateLen,
                        });
                        lastDisplayUpdate = currentTimeSec;
                    }

                    requestAnimationFrame(gameLoop);
                }

                requestAnimationFrame(gameLoop);

            } catch (err) {
                document.getElementById('status').textContent =
                    `❌ Error loading WebAssembly: ${err}`;
                document.getElementById('status').style.color = 'red';
                console.error('Error initializing WASM:', err);
            }
        }

        run();
    </script>
</body>

</html>